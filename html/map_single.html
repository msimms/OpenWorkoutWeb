<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name} - Live Tracking</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
	
<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

</head>

<style type="text/css">
	html { height: 100% }
	body { height: 100%; margin: 0; padding: 0 }
	#map-canvas { height: 75% }

	div.bar
	{
		display: inline-block;
		width: 20px;
		height: 75px;	/* Gets overriden by D3-assigned height below */
		background-color: teal;
	}

	path
	{
		stroke: steelblue;
		stroke-width: 2;
		fill: none;
	}

	.axis path,
	.axis line
	{
		fill: none;
		stroke: #000;
		stroke-width: 1;
		shape-rendering: crispEdges;
	}
</style>

<body>

<section class="nav">
${nav}
</section>

<div id="map-canvas">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhsgYoAKyYFhf3JABWflVMNBDi5tPXvZo"></script>
<script type="text/javascript">
	var contentString
	var routePath
	var map
	var marker = null
	var infoWindow = null
	var lastLat = ${lastLat}
	var lastLon = ${lastLon}

	function escapeRegExp(str)
	{
		return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
	}

	function replaceAll(str, find, replace)
	{
		return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
	}

	function newCoord(x, y)
	{
		return new google.maps.LatLng(x, y);
	}

	function initialize()
	{
		var mapOptions =
		{
			center: newCoord(${centerLat}, ${centerLon}),
			zoom: 12
		};

		map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

		var routeCoordinates =
		[
${route}
		];

		routePath = new google.maps.Polyline
		({
			path: routeCoordinates,
			geodesic: true,
			strokeColor: '#FF0000',
			strokeOpacity: 1.0,
			strokeWeight: 2
		});

		routePath.setMap(map);

		$.ajax({ type: 'POST', url: "${root_url}/update_metadata/${deviceStr}/${activityId}", success: updateMetadata, dataType: "application/json" });
	}

	google.maps.event.addDomListener(window, 'load', initialize);

	var appendToTrack = function(response)
	{
		if (response == null)
			return;
		if (response.length < 3)
			return;
		if (routePath == null)
			return;

		var objList = JSON.parse(response);
		if (objList == null)
			return;
		if (objList.length == 0)
			return;

		for (var i = 0; i < objList.length; ++i)
		{
			var path = routePath.getPath();
			routeCoordinates.push(new google.maps.LatLng(objList[i].latitude, objList[i].longitude));
			routePath.setPath(routeCoordinates);
			routePath.setMap(map);
		}

		lastLat = objList[objList.length - 1].latitude;
		lastLon = objList[objList.length - 1].longitude;
	};

	var updateMetadata = function(response)
	{
		if (response == null)
			return;
		if (response.length < 3)
			return;

		response2 = response.substring(1, response.length - 1);
		response3 = replaceAll(response2, "\\\"", "\"");
		var objList = JSON.parse(response3);
		if (objList == null)
			return;

		contentString = '<div id="content">' +
			'<div id="siteNotice">' +
			'</div>' +
			'<h2 id="firstHeading" class="firstHeading">Last Known Position</h2>' +
			'<div id="bodyContent">' +
			'<p>';
		for (var i = 0; i < objList.length; ++i)
		{
			if (objList[i].name != "Name")
			{
				contentString += objList[i].name;
				contentString += " = ";
				contentString += objList[i].value;
				contentString += "<br>";
			}
		}
		contentString +=
			'</p>' +
			'</div>' +
			'</div>';
			
		if (infoWindow)
		{
			infoWindow.close();
			infoWindow = null;
		}
		if (marker)
		{
			marker.setMap(null);
			marker = null;
		}

		infoWindow = new google.maps.InfoWindow
		({
			content: contentString
		});
		
		marker = new google.maps.Marker
		({
			position: new google.maps.LatLng(lastLat, lastLon),
			map: map,
			title: 'Current Position'
		});

		google.maps.event.addListener(marker, 'click', function()
		{
			infoWindow.open(map, marker);
		});

		infoWindow.open(map, marker);
	};

	var checkForUpdates = function()
	{
		$.ajax({ type: 'POST', url: "${root_url}/update_track/${deviceStr}/${activityId}/${routeLen}", success: appendToTrack, dataType: "application/json" });
		$.ajax({ type: 'POST', url: "${root_url}/update_metadata/${deviceStr}/${activityId}", success: updateMetadata, dataType: "application/json" });
	};

	//setInterval(checkForUpdates, 15000);
</script>

</div>

<div id="charts"/>

<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">
	function drawChart(data, title, color)
	{
		var margin = {top: 20, right: 20, bottom: 20, left: 50},
			width = $("#charts").width() - margin.left - margin.right,
			height = 200 - margin.top - margin.bottom;

		var x = d3.time.scale().range([0, width]);
		var y = d3.scale.linear().range([height, 0]);

		var xAxis = d3.svg.axis().scale(x).orient("bottom");
		var yAxis = d3.svg.axis().scale(y).orient("left").ticks(5);

		var valueline = d3.svg.line()
			.x(function(d) { return x(d.date); })
			.y(function(d) { return y(d.value); });

		var svg = d3.select("#charts")
			.append("svg:svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		x.domain(d3.extent(data, function(d) { return d.date; }));
		y.domain(d3.extent(data, function(d) { return d.value; }));

		svg.append("path")
			.attr("class", "line")
			.attr("d", valueline(data))
			.style("stroke", color);
		svg.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);
		svg.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end")
			.text(title);
	}

	var speeds = [
${currentSpeeds}
	];
	var heartRates = [
${heartRates}
	];
	var powers = [
${powers}
	];

	if (speeds.length > 0)
		$(function() { drawChart(speeds, "Speed", "DodgerBlue") });
	if (heartRates.length > 0)
		$(function() { drawChart(heartRates, "BPM", "FireBrick") });
	if (powers.length > 0)
		$(function() { drawChart(powers, "Watts", "ForestGreen") });
</script>

</div>

</body>

</html>
